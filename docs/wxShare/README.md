> æœ€è¿‘åšçš„é¡¹ç›®éœ€è¦åœ¨å¾®ä¿¡ä¸­äºŒæ¬¡åˆ†äº«ï¼Œä½†æ˜¯è¿™ä¸ªè¿‡ç¨‹ä¸­é‡åˆ°ä¸å°‘å‘ï¼Œæ‰€ä»¥è®°å½•ä¸€ä¸‹ã€‚è‡³äºä¸ºä»€ä¹ˆå‘å¤šï¼Ÿä¸»è¦æ˜¯å¹³æ—¶æ¯”è¾ƒç²—å¿ƒï¼Œæ–‡æ¡£çœ‹çš„ä¸å¤Ÿä»”ç»†ï¼Œå…¶å®æ–‡æ¡£å·²ç»è¯´çš„å¾ˆè¯¦ç»†äº†ï¼Œæˆ‘é‡åˆ°å¥½å¤šçš„é—®é¢˜éƒ½æ˜¯å†ä»”ç»†çœ‹çœ‹æ–‡æ¡£è§£å†³çš„ï¼›ä¸‹é¢æˆ‘å°±æŒ‰ç…§æˆ‘çš„å¼€å‘é¡ºåºå†™ä¸€å†™ï¼Œé¡ºä¾¿å¡«ä¸€ä¸‹å‘ï¼›

# å‡†å¤‡ï¼Œé…ç½®

é¦–å…ˆè¦ç”³è¯·ä¸€ä¸ªå…¬ä¼—å·ï¼Œè€Œä¸”è¦æ˜¯ä¼ä¸šå…¬ä¼—å·ï¼ä¸ºä»€ä¹ˆï¼Ÿå› ä¸ºæ™®é€šè´¦å·ä¸æ”¯æŒåˆ†äº«ï¼ï¼ï¼å‡­å•¥ï¼Ÿï¼

## ç¬¬ä¸€æ­¥ï¼šå‡†å¤‡

è¿›å…¥è‡ªå·±çš„å…¬ä¼—å·ï¼Œä½ç½®ï¼šå¼€å‘>åŸºæœ¬é…ç½®ï¼›åœ¨è¿™é‡Œæ‹¿åˆ° AppID å’Œ AppSecretï¼Œè¿™ä¸¤ä¸ªå°±æ˜¯è¦åœ¨åé¢è·å– token çš„ api çš„å‚æ•°ï¼›éœ€è¦æ³¨æ„å¹³å°ä¸ä¼šå­˜å‚¨ AppSecretï¼Œä¹Ÿä¸è¦æŠŠ AppSecret æ”¾åˆ°å‰ç«¯æš´éœ²å‡ºæ¥ï¼Œæˆ‘ä»¬æ”¾åˆ° node é‡Œï¼›

IP ç™½åå•ä¹Ÿé¡ºä¾¿é…ç½®ä¸€ä¸‹ï¼Œå°±æ˜¯è°ƒç”¨è·å– access_token æ¥å£æ—¶ï¼Œéœ€è¦è®¾ç½®è®¿é—®æ¥æº IP ä¸ºç™½åå•ã€‚ä¹Ÿå°±æ˜¯æˆ‘ä»¬ç”¨çš„ node æœåŠ¡å™¨ ipï¼›éœ€è¦æ³¨æ„ä¸‹çš„ ip åˆ«è·å–æˆå†…ç½‘çš„ ipï¼ï¼Œå¦‚æœä¸çŸ¥é“ç™¾åº¦æœç´¢ ip å°±èƒ½æŸ¥åˆ°äº†ï¼›

![](https://user-gold-cdn.xitu.io/2018/12/1/16767d194bbc595f?w=2322&h=884&f=jpeg&s=106932)

ç„¶åç»§ç»­å† å…¬ä¼—å·è®¾ç½®>åŠŸèƒ½è®¾ç½®ï¼›é…ç½® js æ¥å£å®‰å…¨åŸŸåï¼Œè¿™é‡Œä»‹ç»ä¹Ÿå¾ˆè¯¦ç»†é…ç½®å¥½åŸŸåï¼Œå°±å¯ä»¥è°ƒç”¨ js äº†ï¼Œè¿˜æœ‰å¾®ä¿¡æä¾›çš„ç­¾åæ–‡ä»¶è¦æ”¾åˆ°é…ç½®çš„åŸŸåä¸‹ã€‚

> ä½†è¿™é‡Œæœ‰ä¸ªè¦æ³¨æ„,ç­¾åæ–‡ä»¶æ”¾ç½®çš„è·¯å¾„è¦å’Œé…ç½®åŸŸåè·¯å¾„ä¸€æ ·ã€‚

![](https://user-gold-cdn.xitu.io/2018/12/1/167686a342aa8c87?w=2590&h=1446&f=jpeg&s=231649)
åˆ°è¿™é‡Œå‡†å¤‡å·¥ä½œå®Œæˆï¼Œå‰©ä¸‹çš„å°±æ˜¯æ’¸ä»£ç äº†

## ç¬¬äºŒæ­¥ï¼šä»£ç 

### node ä»£ç 

æˆ‘ä»¬é¡¹ç›®åŠ äº†ä¸€å±‚ node(ç”¨çš„æ˜¯ thinkjs æ¡†æ¶)ï¼Œæ‰€ä»¥ç”Ÿæˆç­¾å(signature)å°±ç›´æ¥è‡ªå·±æå®šï¼›å…ˆæ¥å‡ è¡Œä»£ç çœ‹ä¸€ä¸‹ç”Ÿæˆç­¾åçš„é¡ºåºã€‚ `è¿™é‡Œä¸»è¦çœ‹ä¸€ä¸‹è¿‡ç¨‹ï¼Œæ‰€ä»¥æ²¡æœ‰åˆ—å‡ºå…·ä½“çš„ä»£ç å®ç°ï¼Œåªæ‘˜äº†ä¸€éƒ¨åˆ†æ‹¼å‡‘ä¸€ä¸‹`

```JavaScript
// éšæœºæ•°
const noncestr = Math.random().toString(36).substr(2);
// æ—¶é—´æˆ³
const timestamp = parseInt(new Date().getTime() / 1000);
// url
const url = this.ctx.param('url');
// å¾®ä¿¡è¯·æ±‚åœ°å€
const wx = {
    'appId': 'xxxxxxxxx',
    'appSecret': 'xxxxxxxxxx',
    'tokenUrl': `https://api.weixin.qq.com/cgi-bin/token`,
    'ticketUrl': `https://api.weixin.qq.com/cgi-bin/ticket/getticket`
    }
// è·å–å¹¶å­˜å‚¨token
const accessToken = await this.getDataFromCache(
    ACCESS_TOKEN_KEY,
    this.getAccessToken(wx)
);
// è·å–å¹¶å­˜å‚¨ticket
const ticket = await this.getDataFromCache(
    JS_TICKET_KEY,
    this.getJsTicket(wx, accessToken)
);
// ç”Ÿæˆ
const signature = generateWXSign({
    'jsapi_ticket': ticket,
    'noncestr': noncestr,
    'timestamp': timestamp,
    'url': url
});
return  { noncestr, timestamp, signature, wx.appId }
```

é¦–å…ˆæˆ‘ä»¬è¦æ‹¿åˆ° tokenï¼Œé€šè¿‡ token å†è·å– ticketï¼Œæœ‰äº† ticket å°±å¯ä»¥æ ¹æ®è…¾è®¯çš„ç®—æ³•å¾—åˆ° signature äº†ï¼ä¸‹é¢æ¥æ®µæ ¹æ®è…¾è®¯æä¾›çš„ç®—æ³•ç”³è¯·ç­¾åçš„ä»£ç ï¼›è¿˜æœ‰ä¸çŸ¥é“ url æœ‰ä»€ä¹ˆä¹±ä¸ƒå…«ç³Ÿçš„å­—ç¬¦ï¼Œæ‰€ä»¥ decodeURIComponent æ˜¯å¿…é¡»çš„

> token,ticket è¿™æ¥è´§ éƒ½æœ‰æ—¶æ•ˆ 2 å°æ—¶ï¼Œæ“ä½œä¸å¥½å°± bug

å†é™„ä¸Šä¸¤ä¸ªé“¾æ¥ï¼Œå®˜æ–¹çš„è°ƒè¯•å·¥å…·ï¼š

-   éªŒè¯ appid å’Œ appsecret
    url: https://mp.weixin.qq.com/debug?token=2058842911&lang=zh_CN
-   éªŒè¯ signature æ˜¯å¦æ­£ç¡®
    url: https://mp.weixin.qq.com/debug/cgi-bin/sandbox?t=jsapisign

```JavaScript
import CryptoJS from 'crypto-js';

const genParamsStr = params => {
    const keys = Object.keys(params);
    return keys
        .sort()
        .reduce((ret, key) => {
            if ( params[key]) {
                ret.push(key + '=' + decodeURIComponent(params[key]));
                return ret;
            }
            return '';
        }, [])
        .join('&');
};

module.exports = {
    generateWXSign(panam) {
        let signParam = genParamsStr(panam);
        return CryptoJS.SHA1(signParam).toString();
    }
};
```

æœ€å¼€å§‹çš„ noncestr éšæœºæ•°ï¼Œtimestamp æ—¶é—´æˆ³ï¼Œurlï¼Œè¿™ä¸‰ä¸ªå€¼åœ¨å‰ç«¯ä»£ç ä¸­ï¼Œå¾®ä¿¡é…ç½®éƒ¨åˆ†ä¹Ÿæ˜¯éœ€è¦çš„ï¼Œæ‰€ä»¥ç”Ÿæˆ signature åè¦ä¸€èµ·è¿”å›ï¼›

åˆ°è¿™å„¿ node éƒ¨åˆ†å°±ç»“æŸäº†å—ï¼Ÿnoï¼æ­¤å¤„æœ‰ä¸€ä¸ªå‘ä¼šåœ¨ä¸‹é¢â€˜å¡«å‘â€™éƒ¨åˆ†è®²ä¸€ä¸‹ï¼›

### js éƒ¨åˆ†

å…ˆæŠŠæœ€åŸºæœ¬çš„äº‹å¹²äº†ï¼Œæ’¸ä¸€éå®˜æ–¹æ–‡æ¡£ï¼ˆhttps://mp.weixin.qq.com/wiki?t=resource/res_main&id=mp1421141115 ï¼‰ï¼Œå†å¼•å…¥è…¾è®¯çš„ jsï¼Œéœ€è¦æ³¨æ„å®˜ç½‘æä¾›çš„æœ€æ–°ç‰ˆæœ¬ï¼Œç„¶åæ”¯æŒä¸€ä¸‹ httpï¼Œhttpsï¼›

```javascript
<script src="//res.wx.qq.com/open/js/jweixin-1.4.0.js" />
```

ç°åœ¨æˆ‘ä»¬å†æ‹¿å‡ºã€Š[å¾®ä¿¡ JS-SDK è¯´æ˜æ–‡æ¡£](https://mp.weixin.qq.com/wiki?t=resource/res_main&id=mp1421141115)ã€‹å¦‚ä¸‹ï¼Œç«Ÿç„¶æœ‰ 4 ä¸ªå¡«ç©ºé¢˜ï¼ä½†æˆ‘ä¸æ€•ï¼Œä¸Šé¢çš„ node å·²ç»è¿”å›äº†ï¼Œå–åˆ°ç›´æ¥å¡«ä¸Šå°±å¥½äº†ï¼›
æœ‰ä¸ªè¦æ³¨æ„ debug è¿™ä¸ªå‚æ•°ä¸ç®¡å¯¹é”™ï¼Œè®¾ç½® true éƒ½ alertï¼›

```javascript
wx.config({
    debug: true, // å¼€å¯è°ƒè¯•æ¨¡å¼,è°ƒç”¨çš„æ‰€æœ‰apiçš„è¿”å›å€¼ä¼šåœ¨å®¢æˆ·ç«¯alertå‡ºæ¥ï¼Œè‹¥è¦æŸ¥çœ‹ä¼ å…¥çš„å‚æ•°ï¼Œå¯ä»¥åœ¨pcç«¯æ‰“å¼€ï¼Œå‚æ•°ä¿¡æ¯ä¼šé€šè¿‡logæ‰“å‡ºï¼Œä»…åœ¨pcç«¯æ—¶æ‰ä¼šæ‰“å°ã€‚
    appId: "", // å¿…å¡«ï¼Œå…¬ä¼—å·çš„å”¯ä¸€æ ‡è¯†
    timestamp: "", // å¿…å¡«ï¼Œç”Ÿæˆç­¾åçš„æ—¶é—´æˆ³
    nonceStr: "", // å¿…å¡«ï¼Œç”Ÿæˆç­¾åçš„éšæœºä¸²
    signature: "", // å¿…å¡«ï¼Œç­¾å
    jsApiList: [] // å¿…å¡«ï¼Œéœ€è¦ä½¿ç”¨çš„JSæ¥å£åˆ—è¡¨
});
```

é™„ä¸Šä¸€ä¸ªå›¾

![](https://user-gold-cdn.xitu.io/2018/12/1/16769216457534dc?w=1048&h=818&f=jpeg&s=72210)
è™½ç„¶è¦åºŸå¼ƒ onMenuShareAppMessageï¼ŒonMenuShareTimeline ä½†æˆ‘è¿˜æ˜¯ç»§ç»­å»¶ç”¨äº†ï¼Œå› ä¸º updateAppMessageShareData ä»–ä»¬ç«Ÿç„¶ã€‚ã€‚ã€‚æŠ¥é”™ï¼ŒæŸ¥äº†ä¸€ä¸‹å¥½åƒæ˜¯ç‰ˆæœ¬é—®é¢˜ï¼Œä½†å·²ç»æ˜¯æœ€æ–°çš„ js è¿˜æ˜¯æŠ¥é”™ã€‚æ²¡æœ‰å†ç»§ç»­æ’æŸ¥é—®é¢˜ï¼Œæ—¢ç„¶ sdk è¯´â€˜å³å°†åºŸå¼ƒâ€™é‚£å°±æ˜¯è¿˜æ²¡åºŸå¼ƒï¼Œæˆ‘å°±å·æ‡’ç»§ç»­ç”¨äº†ï¼›

```javascript
wx.ready(() => {
    // åˆ†äº«å¥½å‹
    wx.onMenuShareAppMessage({
        title: share.product_title, // åˆ†äº«æ ‡é¢˜
        desc: share.product_description, // åˆ†äº«æè¿°
        link: window.location.href, // åˆ†äº«é“¾æ¥ï¼Œè¯¥é“¾æ¥åŸŸåæˆ–è·¯å¾„å¿…é¡»ä¸å½“å‰é¡µé¢å¯¹åº”çš„å…¬ä¼—å·JSå®‰å…¨åŸŸåä¸€è‡´
        imgUrl: share.product_image_url, // åˆ†äº«å›¾æ ‡
        success: function() {
            console.log("onMenuShareAppMessageï¼š success");
        }
    });
    // åˆ†äº«æœ‹å‹åœˆ
    wx.onMenuShareTimeline({
        title: share.product_title, // åˆ†äº«æ ‡é¢˜
        link: window.location.href, // åˆ†äº«é“¾æ¥ï¼Œè¯¥é“¾æ¥åŸŸåæˆ–è·¯å¾„å¿…é¡»ä¸å½“å‰é¡µé¢å¯¹åº”çš„å…¬ä¼—å·JSå®‰å…¨åŸŸåä¸€è‡´
        imgUrl: share.product_image_url, // åˆ†äº«å›¾æ ‡
        success: function() {
            // ç”¨æˆ·ç‚¹å‡»äº†åˆ†äº«åæ‰§è¡Œçš„å›è°ƒå‡½æ•°
        }
    });
});
```

é™„ä¸Šæœ€åçš„ä»£ç ï¼Œåˆ°è¿™ä¸€æ­¥åˆ†äº«å°±å·²ç»å®Œæˆäº†ï¼›åé¢è¯´ä¸€ä¸‹æˆ‘é‡åˆ°å‘ï¼Œæˆ–è€…æ˜¯æˆ‘è‡ªå·±çŠ¯çš„é”™ï¼›

## ç¬¬ä¸‰æ­¥ å‘

> ä¸‹é¢åˆ—ä¸€ä¸‹æˆ‘é‡åˆ°çš„é—®é¢˜ï¼Œå¸Œæœ›å¯¹çœ‹åˆ°è¿™ç¯‡æ–‡ç« çš„äººæœ‰æ‰€å¸®åŠ©

1.  è·å– tokenï¼Œticket æŠ¥çš„é”™è¯¯ 'invalid ip 221.223.000.000, not in whitelist hint:[]'æç¤ºçš„å¾ˆæ˜æ˜¾äº†ç™½åå•æ²¡é…å¯¹ï¼Œè§£å†³ç®€å•ç²˜è´´æç¤ºçš„ ip åˆ°å…¬ä¼—å·é‡Œé¢çš„ ip ç™½åå•å°±å¥½äº†ï¼›

![](https://user-gold-cdn.xitu.io/2018/12/3/1676fe22ef65d16b?w=1320&h=104&f=jpeg&s=47179)

2. è¿è¡Œåˆšå†™å®Œä»£ç ä¹Ÿè®¸æœ‰ä¸ª 'invalid signature' ç­¾åé”™è¯¯ï¼Œä¹Ÿå¾ˆç®€å•éªŒè¯ä¸€ä¸‹å°±å¥½äº†ï¼Œä¸Šé¢éƒ¨åˆ†æœ‰é™„ä¸Šå®˜æ–¹æµ‹è¯•å·¥å…·ï¼›

![](https://user-gold-cdn.xitu.io/2018/12/3/1676fe5ddb4e79b5?w=1100&h=140&f=jpeg&s=44764)
æˆªå›¾

![](https://user-gold-cdn.xitu.io/2018/12/3/1676fec8bc2c9aa3?w=1438&h=1272&f=jpeg&s=302763)

3.  Error:invalid url domain ,è¿™ä¸ªé”™è¯¯å°±æ˜¯å…¬ä¼—å·ä¸­è®¾ç½®ã€ŠJS æ¥å£å®‰å…¨åŸŸåã€‹è®¾ç½®é—®é¢˜ï¼å…ˆçœ‹æä¾›çš„ç­¾å txt æ–‡ä»¶æ²¡æœ‰æ”¾å¯¹ä½ç½®ï¼ŒåŸŸåå¯¹ä¸å¯¹åˆ«é…ç€æ­£å¼ç¯å¢ƒï¼Œå†æµ‹è¯•ç¯å¢ƒè°ƒç”¨ã€‚

![](https://user-gold-cdn.xitu.io/2018/12/3/1676fed9a732c6d9?w=788&h=276&f=jpeg&s=29505)

4. ã€ŠJS æ¥å£å®‰å…¨åŸŸåã€‹ä¿å­˜ä¸äº†ï¼Ÿæ‰¾ä¸åˆ°é—®é¢˜ï¼Ÿä»”ç»†çœ‹ä¸€ä¸‹å›¾ä¸­çš„çº¢æ¡†éƒ¨åˆ†ï¼

![](https://user-gold-cdn.xitu.io/2018/12/3/1676ff80189b1211?w=1582&h=392&f=jpeg&s=167235)

5. è¿˜æœ‰ä¸ªäº‹è¦æ³¨æ„ï¼Œä¹Ÿæ˜¯ä¸Šé¢ node éƒ¨åˆ†æ²¡æœ‰è§£é‡Šçš„ã€‚çº¿ä¸Šçš„æœåŠ¡å™¨ä¸€èˆ¬éƒ½æ˜¯å¤šå°ï¼ˆè´Ÿè½½å‡è¡¡ï¼‰ï¼Œè€Œæœ€å¼€å§‹æˆ‘ä»¬æ˜¯æŠŠ tokenï¼Œticket ç¼“å­˜åœ¨æœåŠ¡å™¨ï¼Œè¿™å°±å¯¼è‡´äº†æ¯æ¬¡è®¿é—®å…¶ä¸­ä¸€å°ï¼Œå‰©ä¸‹çš„æœåŠ¡å™¨å­˜çš„ tokenï¼Œtichet å¤±æ•ˆï¼›okï¼Œé‚£å°±æ”¹äº†ç”¨ redisï¼›
6. åˆ°æœ€åäº†ï¼Œè¿˜ä¸è¡Œå—ï¼Ÿé‚£çœ‹çœ‹å…¬ä¼—å·ï¼Œå¼€å‘>æ¥å£æƒé™ è¿™ä¸ªèœå•ï¼ï¼ï¼

![](https://user-gold-cdn.xitu.io/2018/12/3/1677005f8645f13c?w=1612&h=516&f=jpeg&s=97346)

7. æœ€æœ€åäº†ï¼Œè¿˜æœ‰é—®é¢˜å—ï¼Ÿè¯·ç•™è¨€ï¼ä¸€èµ·çœ‹çœ‹ ğŸ˜Š

# æ€»ç»“ä¸€ä¸‹

    ä¸»è¦ä»”ç»†çœ‹æ–‡æ¡£ï¼å¾ˆå¤šæ—¶å€™éƒ½æ˜¯å¿½ç•¥äº†ä¸€äº›ç»†èŠ‚ï¼Œå¯¼è‡´å‘äº†åŠå¤©ã€‚

    è¶Šä¸å¯æ€è®®çš„bugï¼Œè¶Šå¯èƒ½æ˜¯å¼±Xé—®é¢˜å¯¼è‡´çš„ï¼
